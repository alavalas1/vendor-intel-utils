From 2d6e46c2620636456dac4c78f8ab804d9ec53a3d Mon Sep 17 00:00:00 2001
From: "Reddy, Alavala Srinivasa" <alavala.srinivasa.reddy@intel.com>
Date: Fri, 10 Nov 2023 10:12:50 +0530
Subject: [PATCH] Generate avx2 versions of libnueralnetworks.so

Signed-off-by: bodapati <shalini.salomi.bodapati@intel.com>
---
 Android.bp         | 18 ------------------
 apex/Android.bp    |  1 +
 runtime/Android.bp | 28 ++++++++++++++++++++++++++--
 3 files changed, 27 insertions(+), 20 deletions(-)

diff --git a/Android.bp b/Android.bp
index 072045506..67f935aac 100644
--- a/Android.bp
+++ b/Android.bp
@@ -43,24 +43,6 @@ cc_defaults {
         "-Werror",
         "-Wextra",
     ],
-    arch: {
-        x86: {
-            avx2: {
-                cflags: [
-                    "-mavx2",
-                    "-mfma",
-                ],
-            },
-        },
-        x86_64: {
-            avx2: {
-                cflags: [
-                    "-mavx2",
-                    "-mfma",
-                ],
-            },
-        },
-    },
     product_variables: {
         debuggable: { // eng and userdebug builds
             cflags: ["-DNN_DEBUGGABLE"],
diff --git a/apex/Android.bp b/apex/Android.bp
index 464419a82..89eecb3ac 100644
--- a/apex/Android.bp
+++ b/apex/Android.bp
@@ -43,6 +43,7 @@ apex_defaults {
     androidManifest: ":com.android.neuralnetworks-androidManifest",
     native_shared_libs: [
         "libneuralnetworks",
+        "libneuralnetworks_avx2",
     ],
     compile_multilib: "both",
     key: "com.android.neuralnetworks.key",
diff --git a/runtime/Android.bp b/runtime/Android.bp
index 21ec0b9af..5bb127fb1 100644
--- a/runtime/Android.bp
+++ b/runtime/Android.bp
@@ -199,8 +199,8 @@ cc_defaults {
     ],
 }
 
-cc_library_shared {
-    name: "libneuralnetworks",
+cc_defaults {
+    name: "libneuralnetworks_generic",
     llndk: {
         symbol_file: "libneuralnetworks.map.txt",
         override_export_include_dirs: ["include"],
@@ -223,6 +223,30 @@ cc_library_shared {
     },
 }
 
+cc_library_shared {
+    name: "libneuralnetworks",
+    defaults: ["libneuralnetworks_generic"],
+}
+
+cc_library_shared {
+    name: "libneuralnetworks_avx2",
+    defaults: ["libneuralnetworks_generic"],
+    min_sdk_version: "30",
+    arch: {
+        x86: {
+           cflags: [ "-mavx2", "-mfma", ],
+        },
+        x86_64: {
+           cflags: [ "-mavx2", "-mfma", ],
+        },
+    },
+    target: {
+       android: {
+          relative_install_path: "IA-Perf/avx2",
+       },
+    },
+}
+
 // Required for tests (b/147158681)
 cc_library_static {
     name: "libneuralnetworks_static",
-- 
2.17.1

